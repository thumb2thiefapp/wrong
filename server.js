require('./config/config');

const _ = require('lodash');
const express = require('express');
const bodyParser = require('body-parser');
const {ObjectID} = require('mongodb');
var shortid = require('shortid-36');
var date = require('date-and-time');

var {mongoose} = require('./db/mongoose');
var {Licence} = require('./models/licence');
var {User} = require('./models/user');
var {authenticate} = require('./middleware/authenticate');

var app = express();
const port = process.env.PORT;

//app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// --------------------------------
// licence Api for client
// --------------------------------

app.post('/getdetailById', (req, res) => {
  var deviceid = req.body.deviceid;

  Licence.findOne({deviceid}, {}, { sort: { '_id' : -1 } }).then((doc) => {
    if (!doc) {
      return res.status(404).send();
    }

    res.send({doc});
  }).catch((e) => {
    res.status(400).send();
  });
});

app.post('/verifyKey', (req, res) => {
  var key = req.body.key.toLowerCase();
  var deviceid = req.body.deviceid;

  Licence.findOne({key}).then((doc) => {
    if (!doc) {
      return res.status(404).send("no doc");
    }
    //res.send(doc);



    if (doc.active === true) {
      return res.status(404).send("false");
    };
    var days = doc.days;
    var ad = date.format(new Date(), 'DD-MM-YYYY');
    let now = new Date();
    var edd = date.addDays(now, days);
    var ed = date.format(new Date(edd), 'DD-MM-YYYY');
    var active = true;

    Licence.findOneAndUpdate({key}, {$set: {days,ad,ed,active,deviceid}}, {new: true}).then((doc) => {
    if (!doc) {
      return res.status(404).send();
    }

    res.send({doc});
  }).catch((e) => {
    res.status(400).send();
  })


  }).catch((e) => {
    res.status(400).send();
  });
});

// --------------------------------
// licence Api for creater
// --------------------------------


app.post('/createKeys', (req, res) => {
  var days = req.body.days; //actually days
  var keyfor = req.body.keyfor;

  for (var i = 0; i < number; i++) {

    var licence = new Licence({
      key : "av-" + shortid.generate().toLowerCase(),
      days : req.body.days,
      keyfor : req.body.keyfor,
    _creator: req.user._id
    
  });

      licence.save().then((doc) => {
    res.send(doc);
  }, (e) => {
    res.status(400).send(e);
  });
    
  };

});

app.post('/createKey', (req, res) => {
  var result = [
 {
   "key": 2768139
 },
 {
   "key": 53621948
 },
 {
   "key": 41239086
 },
 {
   "key": 95304672
 },
 {
   "key": 65410823
 },
 {
   "key": 68704591
 },
 {
   "key": 31907856
 },
 {
   "key": 70648159
 },
 {
   "key": 47962158
 },
 {
   "key": 10629573
 },
 {
   "key": 82541709
 },
 {
   "key": 54609183
 },
 {
   "key": 19247065
 },
 {
   "key": 26715048
 },
 {
   "key": 48562397
 },
 {
   "key": 46580279
 },
 {
   "key": 49361578
 },
 {
   "key": 96207834
 },
 {
   "key": 90685413
 },
 {
   "key": 36527941
 },
 {
   "key": 9418573
 },
 {
   "key": 73924186
 },
 {
   "key": 81295037
 },
 {
   "key": 80745639
 },
 {
   "key": 80295634
 },
 {
   "key": 92850614
 },
 {
   "key": 8921756
 },
 {
   "key": 16543709
 },
 {
   "key": 9571342
 },
 {
   "key": 34501798
 },
 {
   "key": 8796435
 },
 {
   "key": 78413205
 },
 {
   "key": 9158672
 },
 {
   "key": 92648531
 },
 {
   "key": 64732085
 },
 {
   "key": 24853976
 },
 {
   "key": 74089652
 },
 {
   "key": 20356841
 },
 {
   "key": 89321760
 },
 {
   "key": 38056472
 },
 {
   "key": 45980126
 },
 {
   "key": 16349527
 },
 {
   "key": 74063259
 },
 {
   "key": 43210597
 },
 {
   "key": 80143297
 },
 {
   "key": 80174326
 },
 {
   "key": 68905473
 },
 {
   "key": 42173658
 },
 {
   "key": 39428561
 },
 {
   "key": 31942068
 },
 {
   "key": 31702946
 },
 {
   "key": 28950431
 },
 {
   "key": 86105472
 },
 {
   "key": 37804629
 },
 {
   "key": 64137209
 },
 {
   "key": 8241739
 },
 {
   "key": 86403579
 },
 {
   "key": 12084375
 },
 {
   "key": 73189650
 },
 {
   "key": 47029316
 },
 {
   "key": 61289307
 },
 {
   "key": 75863401
 },
 {
   "key": 3627891
 },
 {
   "key": 94850137
 },
 {
   "key": 67391482
 },
 {
   "key": 92014836
 },
 {
   "key": 70938156
 },
 {
   "key": 15720438
 },
 {
   "key": 29456018
 },
 {
   "key": 17823695
 },
 {
   "key": 61384570
 },
 {
   "key": 71305624
 },
 {
   "key": 34829076
 },
 {
   "key": 32195608
 },
 {
   "key": 36145928
 },
 {
   "key": 2835714
 },
 {
   "key": 36427190
 },
 {
   "key": 85349610
 },
 {
   "key": 48029173
 },
 {
   "key": 96825704
 },
 {
   "key": 40523789
 },
 {
   "key": 46973215
 },
 {
   "key": 23916704
 },
 {
   "key": 21896405
 },
 {
   "key": 46982135
 },
 {
   "key": 27350489
 },
 {
   "key": 47629503
 },
 {
   "key": 69187205
 },
 {
   "key": 51923784
 },
 {
   "key": 79134082
 },
 {
   "key": 28561497
 },
 {
   "key": 83251064
 },
 {
   "key": 65814302
 },
 {
   "key": 40973162
 },
 {
   "key": 6418537
 },
 {
   "key": 41752830
 },
 {
   "key": 61293784
 },
 {
   "key": 87625190
 },
 {
   "key": 84376502
 },
 {
   "key": 76142039
 },
 {
   "key": 91327685
 },
 {
   "key": 35018269
 },
 {
   "key": 15309826
 },
 {
   "key": 96412078
 },
 {
   "key": 90736458
 },
 {
   "key": 95326048
 },
 {
   "key": 34709185
 },
 {
   "key": 64251738
 },
 {
   "key": 26408731
 },
 {
   "key": 8296534
 },
 {
   "key": 63741928
 },
 {
   "key": 65807293
 },
 {
   "key": 63417905
 },
 {
   "key": 15806439
 },
 {
   "key": 95420681
 },
 {
   "key": 81439276
 },
 {
   "key": 37925601
 },
 {
   "key": 62840793
 },
 {
   "key": 89654710
 },
 {
   "key": 89243150
 },
 {
   "key": 39452610
 },
 {
   "key": 20671498
 },
 {
   "key": 78396120
 },
 {
   "key": 32094817
 },
 {
   "key": 4689237
 },
 {
   "key": 69823451
 },
 {
   "key": 89415207
 },
 {
   "key": 45703829
 },
 {
   "key": 9541837
 },
 {
   "key": 56183904
 },
 {
   "key": 12583940
 },
 {
   "key": 9721468
 },
 {
   "key": 14287965
 },
 {
   "key": 93527461
 },
 {
   "key": 41687352
 },
 {
   "key": 72589640
 },
 {
   "key": 61253748
 },
 {
   "key": 74539162
 },
 {
   "key": 19486725
 },
 {
   "key": 97632851
 },
 {
   "key": 28419075
 },
 {
   "key": 89402765
 },
 {
   "key": 21478096
 },
 {
   "key": 45632780
 },
 {
   "key": 7618459
 },
 {
   "key": 8453271
 },
 {
   "key": 13257806
 },
 {
   "key": 98731046
 },
 {
   "key": 23710594
 },
 {
   "key": 51632897
 },
 {
   "key": 80196725
 },
 {
   "key": 82307619
 },
 {
   "key": 4635719
 },
 {
   "key": 56891743
 },
 {
   "key": 62801437
 },
 {
   "key": 98260374
 },
 {
   "key": 37219564
 },
 {
   "key": 26347985
 },
 {
   "key": 76482351
 },
 {
   "key": 31748056
 },
 {
   "key": 81462057
 },
 {
   "key": 9758642
 },
 {
   "key": 7162943
 },
 {
   "key": 67184359
 },
 {
   "key": 90354286
 },
 {
   "key": 78350291
 },
 {
   "key": 64520139
 },
 {
   "key": 80426375
 },
 {
   "key": 89613250
 },
 {
   "key": 46015832
 },
 {
   "key": 95230418
 },
 {
   "key": 89713642
 },
 {
   "key": 21407856
 },
 {
   "key": 14052789
 },
 {
   "key": 93475610
 },
 {
   "key": 7913264
 },
 {
   "key": 37150469
 },
 {
   "key": 36451079
 },
 {
   "key": 8973164
 },
 {
   "key": 56907234
 },
 {
   "key": 58046973
 },
 {
   "key": 42197350
 },
 {
   "key": 81065329
 },
 {
   "key": 47018963
 },
 {
   "key": 37409861
 },
 {
   "key": 62891573
 },
 {
   "key": 93041827
 },
 {
   "key": 2937516
 },
 {
   "key": 43256107
 },
 {
   "key": 29856470
 },
 {
   "key": 30286759
 },
 {
   "key": 80436921
 },
 {
   "key": 58937261
 },
 {
   "key": 42190578
 },
 {
   "key": 49830526
 },
 {
   "key": 53978406
 },
 {
   "key": 63952870
 },
 {
   "key": 70289534
 },
 {
   "key": 9876453
 },
 {
   "key": 17203948
 },
 {
   "key": 20374815
 },
 {
   "key": 97581342
 },
 {
   "key": 42579801
 },
 {
   "key": 63150478
 },
 {
   "key": 41752368
 },
 {
   "key": 36420819
 },
 {
   "key": 86479120
 },
 {
   "key": 76928041
 },
 {
   "key": 29137854
 },
 {
   "key": 8152763
 },
 {
   "key": 48365297
 },
 {
   "key": 26457108
 },
 {
   "key": 49063812
 },
 {
   "key": 80159264
 },
 {
   "key": 15630279
 },
 {
   "key": 13842657
 },
 {
   "key": 76903542
 },
 {
   "key": 69357028
 },
 {
   "key": 72813695
 },
 {
   "key": 68425179
 },
 {
   "key": 95783064
 },
 {
   "key": 73851960
 },
 {
   "key": 53412807
 },
 {
   "key": 95340178
 },
 {
   "key": 18572649
 },
 {
   "key": 12934068
 },
 {
   "key": 15679823
 },
 {
   "key": 43856190
 },
 {
   "key": 90764185
 },
 {
   "key": 6924785
 },
 {
   "key": 46103759
 },
 {
   "key": 27561408
 },
 {
   "key": 78012953
 },
 {
   "key": 25147803
 },
 {
   "key": 91673852
 },
 {
   "key": 38275109
 },
 {
   "key": 13942750
 },
 {
   "key": 84170539
 },
 {
   "key": 58371064
 },
 {
   "key": 93208654
 },
 {
   "key": 92806751
 },
 {
   "key": 58190762
 },
 {
   "key": 6198435
 },
 {
   "key": 43561907
 },
 {
   "key": 26487051
 },
 {
   "key": 30756814
 },
 {
   "key": 2514987
 },
 {
   "key": 26108945
 },
 {
   "key": 23678509
 },
 {
   "key": 62509387
 },
 {
   "key": 90537864
 },
 {
   "key": 16794025
 },
 {
   "key": 61527089
 },
 {
   "key": 81562094
 },
 {
   "key": 25430719
 },
 {
   "key": 45172083
 },
 {
   "key": 52307169
 },
 {
   "key": 58341760
 },
 {
   "key": 45370891
 },
 {
   "key": 53728069
 },
 {
   "key": 40938257
 },
 {
   "key": 85916340
 },
 {
   "key": 32950168
 },
 {
   "key": 73281406
 },
 {
   "key": 25137804
 },
 {
   "key": 60792485
 },
 {
   "key": 92708351
 },
 {
   "key": 73209451
 },
 {
   "key": 59846723
 },
 {
   "key": 75069312
 },
 {
   "key": 14387025
 },
 {
   "key": 71958360
 },
 {
   "key": 69275031
 },
 {
   "key": 3752198
 },
 {
   "key": 45271980
 },
 {
   "key": 56703491
 },
 {
   "key": 62504891
 },
 {
   "key": 83469751
 },
 {
   "key": 14769803
 },
 {
   "key": 61084253
 },
 {
   "key": 20349157
 },
 {
   "key": 12658309
 },
 {
   "key": 29467035
 },
 {
   "key": 78903215
 },
 {
   "key": 91603542
 },
 {
   "key": 91603874
 },
 {
   "key": 34952768
 },
 {
   "key": 39825604
 },
 {
   "key": 82076145
 },
 {
   "key": 75409186
 },
 {
   "key": 49301852
 },
 {
   "key": 13402578
 },
 {
   "key": 64753092
 },
 {
   "key": 87354291
 },
 {
   "key": 91543678
 },
 {
   "key": 23589076
 },
 {
   "key": 35284071
 },
 {
   "key": 70231468
 },
 {
   "key": 52017389
 },
 {
   "key": 6934785
 },
 {
   "key": 92864051
 },
 {
   "key": 65437910
 },
 {
   "key": 4263859
 },
 {
   "key": 42701983
 },
 {
   "key": 79621350
 },
 {
   "key": 53682049
 },
 {
   "key": 97018623
 },
 {
   "key": 3598741
 },
 {
   "key": 9534178
 },
 {
   "key": 40317986
 },
 {
   "key": 9875643
 },
 {
   "key": 1243657
 },
 {
   "key": 97128453
 },
 {
   "key": 24960713
 },
 {
   "key": 5981643
 },
 {
   "key": 54170623
 },
 {
   "key": 32078649
 },
 {
   "key": 23074586
 },
 {
   "key": 89137542
 },
 {
   "key": 25648970
 },
 {
   "key": 68793410
 },
 {
   "key": 21640795
 },
 {
   "key": 60573498
 },
 {
   "key": 92167403
 },
 {
   "key": 58734126
 },
 {
   "key": 4529786
 },
 {
   "key": 51673498
 },
 {
   "key": 86950724
 },
 {
   "key": 71968524
 },
 {
   "key": 83429071
 },
 {
   "key": 8274965
 },
 {
   "key": 32986701
 },
 {
   "key": 2573184
 },
 {
   "key": 20645798
 },
 {
   "key": 47263805
 },
 {
   "key": 73245618
 },
 {
   "key": 60974285
 },
 {
   "key": 87624103
 },
 {
   "key": 45867319
 },
 {
   "key": 46815023
 },
 {
   "key": 25796310
 },
 {
   "key": 1352486
 },
 {
   "key": 68324901
 },
 {
   "key": 41072539
 },
 {
   "key": 23410576
 },
 {
   "key": 39785012
 },
 {
   "key": 89437651
 },
 {
   "key": 41925876
 },
 {
   "key": 72584306
 },
 {
   "key": 36572980
 },
 {
   "key": 38514629
 },
 {
   "key": 59610874
 },
 {
   "key": 85063792
 },
 {
   "key": 43679180
 },
 {
   "key": 71638904
 },
 {
   "key": 49603275
 },
 {
   "key": 40789231
 },
 {
   "key": 87503921
 },
 {
   "key": 45802617
 },
 {
   "key": 35982617
 },
 {
   "key": 23798165
 },
 {
   "key": 24097683
 },
 {
   "key": 92408135
 },
 {
   "key": 80154729
 },
 {
   "key": 38264910
 },
 {
   "key": 62785394
 },
 {
   "key": 12504937
 },
 {
   "key": 8469235
 },
 {
   "key": 26187034
 },
 {
   "key": 87391045
 },
 {
   "key": 59631482
 },
 {
   "key": 87423159
 },
 {
   "key": 37905486
 },
 {
   "key": 96872315
 },
 {
   "key": 1592876
 },
 {
   "key": 91345607
 },
 {
   "key": 60814329
 },
 {
   "key": 31428690
 },
 {
   "key": 82574103
 },
 {
   "key": 25407613
 },
 {
   "key": 97123054
 },
 {
   "key": 67083425
 },
 {
   "key": 82746159
 },
 {
   "key": 98435627
 },
 {
   "key": 1875234
 },
 {
   "key": 25360471
 },
 {
   "key": 87624510
 },
 {
   "key": 89716250
 },
 {
   "key": 56483720
 },
 {
   "key": 93162085
 },
 {
   "key": 70825134
 },
 {
   "key": 12053874
 },
 {
   "key": 2978451
 },
 {
   "key": 45791302
 },
 {
   "key": 69783405
 },
 {
   "key": 5682479
 },
 {
   "key": 94076518
 },
 {
   "key": 57648209
 },
 {
   "key": 47168309
 },
 {
   "key": 26130974
 },
 {
   "key": 50629183
 },
 {
   "key": 92087564
 },
 {
   "key": 96572138
 },
 {
   "key": 2854361
 },
 {
   "key": 49518367
 },
 {
   "key": 57604983
 },
 {
   "key": 15638027
 },
 {
   "key": 84596102
 },
 {
   "key": 69274581
 },
 {
   "key": 51903824
 },
 {
   "key": 69250173
 },
 {
   "key": 37428901
 },
 {
   "key": 28374569
 },
 {
   "key": 62057198
 },
 {
   "key": 30791685
 },
 {
   "key": 20549381
 },
 {
   "key": 93821654
 },
 {
   "key": 76210439
 },
 {
   "key": 28713506
 },
 {
   "key": 50712849
 },
 {
   "key": 98301526
 },
 {
   "key": 7485321
 },
 {
   "key": 20615487
 },
 {
   "key": 61384729
 },
 {
   "key": 72430651
 },
 {
   "key": 48607359
 },
 {
   "key": 49620357
 },
 {
   "key": 67439580
 },
 {
   "key": 12579046
 },
 {
   "key": 95864207
 },
 {
   "key": 83490715
 },
 {
   "key": 79501234
 },
 {
   "key": 20786541
 },
 {
   "key": 71320584
 },
 {
   "key": 30249681
 },
 {
   "key": 46187235
 },
 {
   "key": 4369718
 },
 {
   "key": 82405671
 },
 {
   "key": 84167503
 },
 {
   "key": 81596024
 },
 {
   "key": 58603241
 },
 {
   "key": 23105487
 },
 {
   "key": 54782603
 },
 {
   "key": 76504931
 },
 {
   "key": 24376519
 },
 {
   "key": 1967582
 },
 {
   "key": 69728150
 },
 {
   "key": 72031946
 },
 {
   "key": 79415820
 },
 {
   "key": 42867153
 },
 {
   "key": 97485631
 },
 {
   "key": 42587630
 },
 {
   "key": 68073945
 },
 {
   "key": 79861305
 },
 {
   "key": 78364219
 },
 {
   "key": 31409785
 },
 {
   "key": 1345726
 },
 {
   "key": 96123578
 },
 {
   "key": 80149267
 },
 {
   "key": 57018492
 },
 {
   "key": 21730568
 },
 {
   "key": 27350416
 },
 {
   "key": 18069253
 },
 {
   "key": 29867135
 },
 {
   "key": 54012386
 },
 {
   "key": 53204971
 },
 {
   "key": 43981572
 },
 {
   "key": 21563847
 },
 {
   "key": 65098142
 },
 {
   "key": 98527360
 },
 {
   "key": 79420386
 },
 {
   "key": 5978134
 },
 {
   "key": 26904381
 },
 {
   "key": 46198523
 },
 {
   "key": 81760945
 },
 {
   "key": 58372619
 },
 {
   "key": 96723458
 },
 {
   "key": 45608972
 },
 {
   "key": 57184623
 },
 {
   "key": 74165280
 },
 {
   "key": 98234710
 },
 {
   "key": 21584390
 },
 {
   "key": 9675482
 },
 {
   "key": 95672014
 },
 {
   "key": 7531486
 },
 {
   "key": 82397146
 },
 {
   "key": 60439582
 },
 {
   "key": 94605327
 },
 {
   "key": 92587436
 },
 {
   "key": 94317586
 },
 {
   "key": 16523084
 },
 {
   "key": 63905817
 },
 {
   "key": 80179265
 },
 {
   "key": 48276109
 },
 {
   "key": 15708243
 },
 {
   "key": 74159068
 },
 {
   "key": 28475039
 },
 {
   "key": 75384109
 },
 {
   "key": 63548901
 },
 {
   "key": 40925376
 },
 {
   "key": 10784295
 },
 {
   "key": 56872019
 },
 {
   "key": 72549163
 },
 {
   "key": 9261784
 },
 {
   "key": 79185026
 },
 {
   "key": 82415693
 },
 {
   "key": 31504962
 },
 {
   "key": 82931567
 },
 {
   "key": 2513867
 },
 {
   "key": 80243567
 },
 {
   "key": 53746219
 },
 {
   "key": 92435860
 },
 {
   "key": 34976581
 },
 {
   "key": 46532809
 },
 {
   "key": 2748619
 },
 {
   "key": 52410368
 },
 {
   "key": 74038512
 },
 {
   "key": 59740318
 },
 {
   "key": 78912463
 },
 {
   "key": 54386902
 },
 {
   "key": 52670498
 },
 {
   "key": 19847032
 },
 {
   "key": 79065813
 },
 {
   "key": 73128564
 },
 {
   "key": 97805164
 },
 {
   "key": 30541629
 },
 {
   "key": 83967210
 },
 {
   "key": 89526041
 },
 {
   "key": 32589076
 },
 {
   "key": 6185472
 },
 {
   "key": 2763851
 },
 {
   "key": 32795648
 },
 {
   "key": 19825643
 },
 {
   "key": 40371689
 },
 {
   "key": 35287406
 },
 {
   "key": 35104987
 },
 {
   "key": 17243869
 },
 {
   "key": 81526037
 },
 {
   "key": 48053216
 },
 {
   "key": 58940263
 },
 {
   "key": 61732059
 },
 {
   "key": 52970486
 },
 {
   "key": 34617025
 },
 {
   "key": 76392401
 },
 {
   "key": 42935861
 },
 {
   "key": 81462395
 },
 {
   "key": 6754193
 },
 {
   "key": 31680427
 },
 {
   "key": 92803145
 },
 {
   "key": 46978321
 },
 {
   "key": 25371860
 },
 {
   "key": 75916402
 },
 {
   "key": 15826749
 },
 {
   "key": 94052713
 },
 {
   "key": 48275319
 },
 {
   "key": 35290164
 },
 {
   "key": 28371564
 },
 {
   "key": 86492517
 },
 {
   "key": 40287593
 },
 {
   "key": 9214756
 },
 {
   "key": 68347901
 },
 {
   "key": 30925718
 },
 {
   "key": 54927103
 },
 {
   "key": 74025693
 },
 {
   "key": 8249365
 },
 {
   "key": 39062745
 },
 {
   "key": 43680592
 },
 {
   "key": 79358160
 },
 {
   "key": 14952803
 },
 {
   "key": 54920613
 },
 {
   "key": 3976248
 },
 {
   "key": 80351679
 },
 {
   "key": 80159642
 },
 {
   "key": 41256739
 },
 {
   "key": 64358092
 },
 {
   "key": 10562934
 },
 {
   "key": 93845760
 },
 {
   "key": 15296037
 },
 {
   "key": 21793456
 },
 {
   "key": 49015627
 },
 {
   "key": 70458931
 },
 {
   "key": 73420561
 },
 {
   "key": 69702835
 },
 {
   "key": 54603978
 },
 {
   "key": 24078359
 },
 {
   "key": 2641539
 },
 {
   "key": 87415936
 },
 {
   "key": 75042916
 },
 {
   "key": 21094368
 },
 {
   "key": 69780231
 },
 {
   "key": 40698357
 },
 {
   "key": 30765812
 },
 {
   "key": 72691580
 },
 {
   "key": 29138570
 },
 {
   "key": 14638092
 },
 {
   "key": 23978041
 },
 {
   "key": 8719536
 },
 {
   "key": 81923754
 },
 {
   "key": 14657893
 },
 {
   "key": 85613097
 },
 {
   "key": 86932741
 },
 {
   "key": 1354687
 },
 {
   "key": 76120354
 },
 {
   "key": 46901275
 },
 {
   "key": 53796281
 },
 {
   "key": 23480569
 },
 {
   "key": 91748325
 },
 {
   "key": 28431697
 },
 {
   "key": 79514326
 },
 {
   "key": 54276901
 },
 {
   "key": 42978635
 },
 {
   "key": 16032948
 },
 {
   "key": 45867312
 },
 {
   "key": 23675480
 },
 {
   "key": 25639418
 },
 {
   "key": 59801342
 },
 {
   "key": 37259018
 },
 {
   "key": 97485602
 },
 {
   "key": 92460187
 },
 {
   "key": 60784195
 },
 {
   "key": 5694382
 },
 {
   "key": 4931825
 },
 {
   "key": 32810754
 },
 {
   "key": 21495736
 },
 {
   "key": 18765032
 },
 {
   "key": 56492817
 },
 {
   "key": 26980431
 },
 {
   "key": 80164372
 },
 {
   "key": 65912834
 },
 {
   "key": 43567120
 },
 {
   "key": 96174382
 },
 {
   "key": 39875642
 },
 {
   "key": 95730862
 },
 {
   "key": 23871596
 },
 {
   "key": 98703251
 },
 {
   "key": 12689307
 },
 {
   "key": 4523691
 },
 {
   "key": 29854713
 },
 {
   "key": 74980132
 },
 {
   "key": 25738140
 },
 {
   "key": 8476539
 },
 {
   "key": 23947180
 },
 {
   "key": 58132496
 },
 {
   "key": 53498612
 },
 {
   "key": 28539476
 },
 {
   "key": 8146725
 },
 {
   "key": 5267349
 },
 {
   "key": 48239517
 },
 {
   "key": 24895716
 },
 {
   "key": 72405831
 },
 {
   "key": 92186570
 },
 {
   "key": 59764280
 },
 {
   "key": 13067582
 },
 {
   "key": 80741532
 },
 {
   "key": 42685301
 },
 {
   "key": 28751460
 },
 {
   "key": 23507164
 },
 {
   "key": 76293041
 },
 {
   "key": 26540193
 },
 {
   "key": 59740218
 },
 {
   "key": 13874269
 },
 {
   "key": 21789560
 },
 {
   "key": 72345189
 },
 {
   "key": 82765104
 },
 {
   "key": 95412073
 },
 {
   "key": 85349261
 },
 {
   "key": 70218469
 },
 {
   "key": 51642793
 },
 {
   "key": 26183054
 },
 {
   "key": 14806327
 },
 {
   "key": 65329081
 },
 {
   "key": 4852173
 },
 {
   "key": 95806743
 },
 {
   "key": 94183502
 },
 {
   "key": 91425637
 },
 {
   "key": 35486901
 },
 {
   "key": 42618037
 },
 {
   "key": 35780149
 },
 {
   "key": 18236705
 },
 {
   "key": 94235168
 },
 {
   "key": 14368972
 },
 {
   "key": 8173925
 },
 {
   "key": 43069518
 },
 {
   "key": 86412570
 },
 {
   "key": 6124738
 },
 {
   "key": 81597623
 },
 {
   "key": 97236508
 },
 {
   "key": 27693148
 },
 {
   "key": 96315720
 },
 {
   "key": 54127830
 },
 {
   "key": 51702386
 },
 {
   "key": 49873512
 },
 {
   "key": 67485230
 },
 {
   "key": 19873042
 },
 {
   "key": 65981470
 },
 {
   "key": 30652197
 },
 {
   "key": 73061289
 },
 {
   "key": 15846720
 },
 {
   "key": 50298174
 },
 {
   "key": 62874019
 },
 {
   "key": 69073485
 },
 {
   "key": 56830792
 },
 {
   "key": 52640138
 },
 {
   "key": 60591328
 },
 {
   "key": 94673582
 },
 {
   "key": 38062957
 },
 {
   "key": 64587093
 },
 {
   "key": 41576809
 },
 {
   "key": 60435297
 },
 {
   "key": 37056289
 },
 {
   "key": 58473962
 },
 {
   "key": 30164958
 },
 {
   "key": 13280649
 },
 {
   "key": 53748190
 },
 {
   "key": 75326890
 },
 {
   "key": 39567814
 },
 {
   "key": 81036245
 },
 {
   "key": 19826534
 },
 {
   "key": 14325890
 },
 {
   "key": 18904236
 },
 {
   "key": 41972605
 },
 {
   "key": 61387459
 },
 {
   "key": 40653278
 },
 {
   "key": 81203649
 },
 {
   "key": 23085649
 },
 {
   "key": 26183509
 },
 {
   "key": 2483516
 },
 {
   "key": 13687520
 },
 {
   "key": 28570943
 },
 {
   "key": 65139704
 },
 {
   "key": 24361075
 },
 {
   "key": 57908123
 },
 {
   "key": 29418075
 },
 {
   "key": 95836410
 },
 {
   "key": 83719526
 },
 {
   "key": 14876203
 },
 {
   "key": 94123706
 },
 {
   "key": 24673801
 },
 {
   "key": 12836547
 },
 {
   "key": 85427136
 },
 {
   "key": 3659871
 },
 {
   "key": 1345968
 },
 {
   "key": 72610495
 },
 {
   "key": 74621958
 },
 {
   "key": 58476012
 },
 {
   "key": 42158037
 },
 {
   "key": 63198547
 },
 {
   "key": 39867201
 },
 {
   "key": 65980124
 },
 {
   "key": 70352168
 },
 {
   "key": 53046217
 },
 {
   "key": 62043158
 },
 {
   "key": 61570438
 },
 {
   "key": 63190287
 },
 {
   "key": 41908672
 },
 {
   "key": 43167892
 },
 {
   "key": 92465371
 },
 {
   "key": 54981063
 },
 {
   "key": 24651309
 },
 {
   "key": 47019582
 },
 {
   "key": 91240785
 },
 {
   "key": 57108249
 },
 {
   "key": 40573928
 },
 {
   "key": 51897306
 },
 {
   "key": 29036571
 },
 {
   "key": 35697128
 },
 {
   "key": 54037829
 },
 {
   "key": 56432917
 },
 {
   "key": 65832910
 },
 {
   "key": 53479208
 },
 {
   "key": 23910684
 },
 {
   "key": 62935148
 },
 {
   "key": 16725894
 },
 {
   "key": 20631987
 },
 {
   "key": 73854129
 },
 {
   "key": 79152304
 },
 {
   "key": 49568137
 },
 {
   "key": 74528390
 },
 {
   "key": 83670415
 },
 {
   "key": 45167083
 },
 {
   "key": 75486320
 },
 {
   "key": 36194702
 },
 {
   "key": 15490768
 },
 {
   "key": 92538760
 },
 {
   "key": 85671349
 },
 {
   "key": 42163905
 },
 {
   "key": 10274568
 },
 {
   "key": 38015267
 },
 {
   "key": 37961245
 },
 {
   "key": 3974815
 },
 {
   "key": 21064398
 },
 {
   "key": 7356198
 },
 {
   "key": 87910365
 },
 {
   "key": 91602384
 },
 {
   "key": 3568471
 },
 {
   "key": 42360985
 },
 {
   "key": 92435160
 },
 {
   "key": 6524138
 },
 {
   "key": 94208357
 },
 {
   "key": 94160723
 },
 {
   "key": 65124708
 },
 {
   "key": 52604189
 },
 {
   "key": 78693240
 },
 {
   "key": 29506318
 },
 {
   "key": 5892436
 },
 {
   "key": 6249137
 },
 {
   "key": 90654327
 },
 {
   "key": 96328150
 },
 {
   "key": 74860129
 },
 {
   "key": 53864079
 },
 {
   "key": 72865419
 },
 {
   "key": 70284956
 },
 {
   "key": 47951368
 },
 {
   "key": 96012845
 },
 {
   "key": 56802493
 },
 {
   "key": 45173069
 },
 {
   "key": 39014658
 },
 {
   "key": 34597812
 },
 {
   "key": 8674539
 },
 {
   "key": 62584307
 },
 {
   "key": 69810423
 },
 {
   "key": 50284379
 },
 {
   "key": 53267801
 },
 {
   "key": 28714095
 },
 {
   "key": 74126805
 },
 {
   "key": 7812539
 },
 {
   "key": 59618347
 },
 {
   "key": 76402381
 },
 {
   "key": 52409871
 },
 {
   "key": 75039482
 },
 {
   "key": 25487160
 },
 {
   "key": 70964358
 },
 {
   "key": 36924157
 },
 {
   "key": 8247356
 },
 {
   "key": 49350681
 },
 {
   "key": 6793524
 },
 {
   "key": 68259013
 },
 {
   "key": 4279853
 },
 {
   "key": 63709142
 },
 {
   "key": 7651892
 },
 {
   "key": 78401952
 },
 {
   "key": 19823654
 },
 {
   "key": 90873124
 },
 {
   "key": 36984172
 },
 {
   "key": 53260481
 },
 {
   "key": 15402937
 },
 {
   "key": 91245367
 },
 {
   "key": 18457329
 },
 {
   "key": 38192670
 },
 {
   "key": 1247859
 },
 {
   "key": 74612503
 },
 {
   "key": 2815463
 },
 {
   "key": 86427513
 },
 {
   "key": 74253689
 },
 {
   "key": 90682541
 },
 {
   "key": 65372984
 },
 {
   "key": 43890127
 },
 {
   "key": 20516493
 },
 {
   "key": 9482156
 },
 {
   "key": 2689137
 },
 {
   "key": 82097154
 },
 {
   "key": 98560342
 },
 {
   "key": 12540698
 },
 {
   "key": 91420583
 },
 {
   "key": 74263910
 },
 {
   "key": 51963420
 },
 {
   "key": 68793512
 },
 {
   "key": 20369415
 },
 {
   "key": 90285176
 },
 {
   "key": 67345891
 },
 {
   "key": 75439862
 },
 {
   "key": 52860193
 },
 {
   "key": 15028694
 },
 {
   "key": 62987413
 },
 {
   "key": 98274160
 },
 {
   "key": 40978165
 },
 {
   "key": 7523496
 },
 {
   "key": 4972583
 },
 {
   "key": 81657249
 },
 {
   "key": 65208149
 },
 {
   "key": 48159023
 },
 {
   "key": 64578213
 },
 {
   "key": 61085327
 },
 {
   "key": 58347012
 },
 {
   "key": 18607592
 },
 {
   "key": 65072149
 },
 {
   "key": 85027419
 },
 {
   "key": 1563294
 },
 {
   "key": 10578369
 },
 {
   "key": 61425890
 },
 {
   "key": 72839604
 },
 {
   "key": 81492657
 },
 {
   "key": 92145073
 },
 {
   "key": 12654308
 },
 {
   "key": 57962301
 },
 {
   "key": 74680359
 },
 {
   "key": 60495813
 },
 {
   "key": 72086935
 },
 {
   "key": 9615834
 },
 {
   "key": 31758496
 },
 {
   "key": 62938175
 },
 {
   "key": 93786204
 },
 {
   "key": 98172536
 },
 {
   "key": 30879412
 },
 {
   "key": 34291768
 },
 {
   "key": 37541829
 },
 {
   "key": 50216379
 },
 {
   "key": 4728639
 },
 {
   "key": 87932540
 },
 {
   "key": 50296431
 },
 {
   "key": 63921748
 },
 {
   "key": 91246580
 },
 {
   "key": 36549287
 },
 {
   "key": 32574869
 },
 {
   "key": 64517809
 },
 {
   "key": 54130628
 },
 {
   "key": 9154723
 },
 {
   "key": 71690435
 },
 {
   "key": 26809541
 },
 {
   "key": 2941357
 },
 {
   "key": 5326491
 },
 {
   "key": 18937450
 },
 {
   "key": 72684591
 },
 {
   "key": 9265341
 },
 {
   "key": 17095623
 },
 {
   "key": 70859142
 },
 {
   "key": 93752806
 },
 {
   "key": 95103486
 },
 {
   "key": 39756102
 },
 {
   "key": 73209148
 },
 {
   "key": 97301625
 },
 {
   "key": 39167058
 },
 {
   "key": 74186502
 },
 {
   "key": 63712089
 },
 {
   "key": 56341079
 },
 {
   "key": 19730862
 },
 {
   "key": 59410687
 },
 {
   "key": 71296043
 },
 {
   "key": 63147280
 },
 {
   "key": 35694018
 },
 {
   "key": 47326819
 },
 {
   "key": 53246078
 },
 {
   "key": 67394825
 },
 {
   "key": 51647290
 },
 {
   "key": 47239561
 },
 {
   "key": 2318457
 },
 {
   "key": 21436785
 },
 {
   "key": 47058963
 },
 {
   "key": 50914836
 },
 {
   "key": 47096258
 },
 {
   "key": 34726195
 },
 {
   "key": 73802956
 },
 {
   "key": 36741205
 },
 {
   "key": 13087954
 },
 {
   "key": 52876910
 },
 {
   "key": 31624750
 },
 {
   "key": 27841693
 },
 {
   "key": 35974068
 },
 {
   "key": 35819602
 },
 {
   "key": 86431250
 },
 {
   "key": 16853740
 },
 {
   "key": 56801972
 },
 {
   "key": 85607124
 },
 {
   "key": 57461389
 },
 {
   "key": 16027483
 },
 {
   "key": 94327680
 },
 {
   "key": 94786051
 },
 {
   "key": 14096327
 },
 {
   "key": 7652439
 },
 {
   "key": 39815206
 },
 {
   "key": 31705684
 },
 {
   "key": 30496857
 },
 {
   "key": 28613475
 },
 {
   "key": 61983057
 },
 {
   "key": 37498105
 },
 {
   "key": 15048763
 },
 {
   "key": 6423581
 },
 {
   "key": 79465380
 },
 {
   "key": 68314795
 },
 {
   "key": 59624107
 },
 {
   "key": 64837259
 },
 {
   "key": 60487193
 },
 {
   "key": 79615824
 },
 {
   "key": 57462390
 },
 {
   "key": 70169248
 },
 {
   "key": 37804195
 },
 {
   "key": 5239467
 },
 {
   "key": 17840935
 },
 {
   "key": 92084176
 },
 {
   "key": 93576048
 },
 {
   "key": 36980417
 },
 {
   "key": 91732086
 },
 {
   "key": 79021358
 },
 {
   "key": 49821507
 },
 {
   "key": 23197640
 },
 {
   "key": 24089536
 },
 {
   "key": 71089246
 },
 {
   "key": 51209834
 },
 {
   "key": 57896321
 },
 {
   "key": 18279640
 },
 {
   "key": 87403526
 },
 {
   "key": 18642390
 },
 {
   "key": 54217890
 },
 {
   "key": 57128306
 },
 {
   "key": 89201765
 },
 {
   "key": 78021596
 },
 {
   "key": 46803257
 },
 {
   "key": 92741358
 },
 {
   "key": 35986240
 },
 {
   "key": 97586204
 },
 {
   "key": 24531069
 },
 {
   "key": 70963814
 },
 {
   "key": 69524037
 },
 {
   "key": 49586317
 },
 {
   "key": 63574098
 },
 {
   "key": 52764801
 },
 {
   "key": 81369450
 },
 {
   "key": 40985371
 },
 {
   "key": 52349860
 },
 {
   "key": 47932608
 },
 {
   "key": 35082974
 },
 {
   "key": 50749812
 },
 {
   "key": 87321549
 },
 {
   "key": 24513760
 },
 {
   "key": 20376914
 },
 {
   "key": 48791302
 },
 {
   "key": 70492186
 },
 {
   "key": 69382047
 },
 {
   "key": 23506478
 },
 {
   "key": 62845710
 },
 {
   "key": 68749513
 },
 {
   "key": 47361508
 },
 {
   "key": 13485976
 },
 {
   "key": 35624187
 },
 {
   "key": 10954386
 },
 {
   "key": 65041392
 },
 {
   "key": 91628347
 },
 {
   "key": 34068517
 },
 {
   "key": 1249783
 },
 {
   "key": 97156840
 },
 {
   "key": 51869273
 },
 {
   "key": 86295430
 },
 {
   "key": 5862741
 },
 {
   "key": 24896130
 },
 {
   "key": 69230178
 },
 {
   "key": 82531096
 },
 {
   "key": 35790214
 },
 {
   "key": 13804276
 },
 {
   "key": 47123980
 },
 {
   "key": 1752948
 },
 {
   "key": 41607285
 },
 {
   "key": 45321678
 },
 {
   "key": 69087534
 },
 {
   "key": 93105674
 },
 {
   "key": 78920453
 },
 {
   "key": 6251937
 },
 {
   "key": 37916528
 },
 {
   "key": 52678193
 },
 {
   "key": 6138492
 },
 {
   "key": 12849705
 },
 {
   "key": 58471362
 },
 {
   "key": 91502786
 },
 {
   "key": 93284751
 },
 {
   "key": 14698703
 },
 {
   "key": 78943615
 },
 {
   "key": 31267508
 },
 {
   "key": 56213897
 },
 {
   "key": 93547026
 },
 {
   "key": 9135247
 },
 {
   "key": 80932541
 },
 {
   "key": 79640852
 },
 {
   "key": 14097368
 },
 {
   "key": 60432759
 },
 {
   "key": 53796241
 },
 {
   "key": 71260895
 },
 {
   "key": 82546107
 },
 {
   "key": 79038516
 },
 {
   "key": 50378629
 },
 {
   "key": 6827391
 },
 {
   "key": 94536021
 },
 {
   "key": 60175824
 },
 {
   "key": 24196875
 },
 {
   "key": 34289076
 },
 {
   "key": 56218790
 },
 {
   "key": 28701936
 },
 {
   "key": 63790152
 },
 {
   "key": 54039687
 },
 {
   "key": 7398562
 },
 {
   "key": 69082415
 },
 {
   "key": 41852076
 },
 {
   "key": 40592671
 },
 {
   "key": 42790136
 },
 {
   "key": 49826107
 },
 {
   "key": 50428317
 },
 {
   "key": 96235480
 },
 {
   "key": 83142679
 },
 {
   "key": 94620315
 },
 {
   "key": 29453780
 },
 {
   "key": 69243187
 },
 {
   "key": 19647250
 },
 {
   "key": 75439082
 },
 {
   "key": 49856132
 },
 {
   "key": 69532418
 },
 {
   "key": 82475136
 },
 {
   "key": 4761829
 },
 {
   "key": 37096124
 },
 {
   "key": 43681902
 },
 {
   "key": 56930172
 },
 {
   "key": 54863019
 },
 {
   "key": 52814796
 },
 {
   "key": 35874016
 },
 {
   "key": 80967352
 },
 {
   "key": 97124635
 },
 {
   "key": 24079168
 },
 {
   "key": 48035612
 },
 {
   "key": 82463710
 },
 {
   "key": 94357016
 },
 {
   "key": 54730816
 },
 {
   "key": 47195230
 },
 {
   "key": 9617543
 },
 {
   "key": 47910582
 },
 {
   "key": 47231085
 },
 {
   "key": 23718560
 },
 {
   "key": 89264173
 },
 {
   "key": 76819042
 },
 {
   "key": 2918437
 },
 {
   "key": 83902415
 },
 {
   "key": 37296150
 },
 {
   "key": 15687392
 },
 {
   "key": 15089347
 },
 {
   "key": 75026183
 },
 {
   "key": 8254937
 },
 {
   "key": 53601924
 },
 {
   "key": 75694231
 },
 {
   "key": 89107352
 },
 {
   "key": 64038127
 },
 {
   "key": 63840972
 },
 {
   "key": 62139748
 },
 {
   "key": 84963501
 },
 {
   "key": 81095324
 },
 {
   "key": 43728561
 },
 {
   "key": 38096275
 },
 {
   "key": 67023814
 },
 {
   "key": 74086235
 },
 {
   "key": 59241368
 },
 {
   "key": 75836409
 },
 {
   "key": 84931025
 },
 {
   "key": 90617234
 },
 {
   "key": 39214576
 },
 {
   "key": 25619874
 },
 {
   "key": 16948320
 },
 {
   "key": 41576098
 },
 {
   "key": 82037645
 },
 {
   "key": 42906718
 },
 {
   "key": 46591782
 },
 {
   "key": 75463180
 },
 {
   "key": 13047895
 },
 {
   "key": 35126874
 },
 {
   "key": 96374518
 },
 {
   "key": 48291365
 },
 {
   "key": 10986254
 },
 {
   "key": 73105429
 },
 {
   "key": 41980326
 },
 {
   "key": 97615342
 },
 {
   "key": 63914250
 },
 {
   "key": 4826513
 },
 {
   "key": 63190725
 },
 {
   "key": 74398502
 },
 {
   "key": 50893746
 },
 {
   "key": 35907186
 },
 {
   "key": 1572689
 },
 {
   "key": 38641520
 },
 {
   "key": 68219540
 },
 {
   "key": 15276084
 },
 {
   "key": 82593706
 },
 {
   "key": 9328714
 },
 {
   "key": 97830564
 },
 {
   "key": 95318276
 },
 {
   "key": 57106283
 },
 {
   "key": 76592481
 },
 {
   "key": 13925604
 },
 {
   "key": 92415368
 },
 {
   "key": 80543972
 },
 {
   "key": 49012586
 },
 {
   "key": 45089367
 },
 {
   "key": 35172864
 },
 {
   "key": 21785096
 },
 {
   "key": 59481723
 },
 {
   "key": 65410789
 },
 {
   "key": 95764120
 },
 {
   "key": 47653198
 },
 {
   "key": 80274135
 },
 {
   "key": 73182054
 },
 {
   "key": 19746320
 },
 {
   "key": 36028471
 },
 {
   "key": 25843796
 },
 {
   "key": 31895642
 },
 {
   "key": 46502937
 },
 {
   "key": 79308521
 },
 {
   "key": 35017826
 },
 {
   "key": 6239785
 },
 {
   "key": 28173064
 },
 {
   "key": 56489023
 },
 {
   "key": 25074836
 },
 {
   "key": 45876329
 },
 {
   "key": 20935681
 },
 {
   "key": 83061792
 },
 {
   "key": 50174638
 },
 {
   "key": 29570314
 },
 {
   "key": 71240639
 },
 {
   "key": 41598370
 },
 {
   "key": 12734569
 },
 {
   "key": 54306197
 },
 {
   "key": 36145078
 },
 {
   "key": 19784320
 },
 {
   "key": 70824365
 },
 {
   "key": 35261470
 },
 {
   "key": 6841529
 },
 {
   "key": 91658420
 },
 {
   "key": 46981752
 },
 {
   "key": 93458126
 },
 {
   "key": 17568403
 },
 {
   "key": 51042876
 },
 {
   "key": 52619378
 },
 {
   "key": 16304827
 },
 {
   "key": 3872659
 },
 {
   "key": 57489312
 },
 {
   "key": 57432981
 },
 {
   "key": 10846527
 },
 {
   "key": 47530982
 },
 {
   "key": 39426178
 },
 {
   "key": 49286350
 },
 {
   "key": 6143859
 },
 {
   "key": 18692470
 },
 {
   "key": 19243567
 },
 {
   "key": 18425370
 },
 {
   "key": 31284769
 },
 {
   "key": 20865179
 },
 {
   "key": 6473982
 },
 {
   "key": 52816903
 },
 {
   "key": 17059326
 },
 {
   "key": 25183674
 },
 {
   "key": 48259016
 },
 {
   "key": 42059183
 },
 {
   "key": 59264801
 },
 {
   "key": 71602984
 },
 {
   "key": 52970843
 },
 {
   "key": 20791635
 },
 {
   "key": 97843506
 },
 {
   "key": 94530786
 },
 {
   "key": 84790623
 },
 {
   "key": 60345927
 },
 {
   "key": 50862743
 },
 {
   "key": 38194256
 },
 {
   "key": 69705832
 },
 {
   "key": 59831427
 },
 {
   "key": 65784912
 },
 {
   "key": 64897315
 },
 {
   "key": 92673408
 },
 {
   "key": 43259867
 },
 {
   "key": 42591367
 },
 {
   "key": 1879563
 },
 {
   "key": 19870352
 },
 {
   "key": 15693702
 },
 {
   "key": 16249087
 },
 {
   "key": 37269081
 },
 {
   "key": 25016379
 },
 {
   "key": 81540269
 },
 {
   "key": 89314072
 },
 {
   "key": 40619725
 },
 {
   "key": 9283641
 },
 {
   "key": 36451728
 },
 {
   "key": 63780912
 },
 {
   "key": 1743689
 },
 {
   "key": 7136824
 }
];

for(var i in result){
    var key = i;
    var val = result[i];
    for(var j in val){
        var sub_key = j;
        var sub_val = val[j];
        //console.log(sub_val);

   var licence = new Licence({
    key : sub_val,
    days : req.body.days,
    keyfor : req.body.keyfor

  });

  licence.save().then((doc) => {
    res.send(doc);
    }, (e) => {
    res.status(400).send(e);
  });
    }
}


});


app.post('/getAllKey',  (req, res) => {
  Licence.find({active : false}).then((doc) => {
    res.send({doc});
  }, (e) => {
    res.status(400).send(e);
  });
});



app.post('/getKeyfor',  (req, res) => {
  var keyfor = req.body.keyfor;
  Licence.find({keyfor}).then((doc) => {
    res.send({doc});
  }, (e) => {
    res.status(400).send(e);
  });
});


app.post('/getdetailByKey',  (req, res) => {
  var key = req.body.key.toLowerCase();

  Licence.findOne({key}).then((doc) => {
    if (!doc) {
      return res.status(404).send();
    }

    res.send({doc});
  }).catch((e) => {
    res.status(400).send();
  });
});


app.post('/removeKey', (req, res) => {
  var key = req.body.key.toLowerCase();

  Licence.findOneAndRemove({key}).then((doc) => {
    if (!doc) {
      return res.status(404).send();
    }

    res.send({doc});
  }).catch((e) => {
    res.status(400).send();
    
  });
});


app.post('/updateKey',  (req, res) => {

  var key = req.body.key.toLowerCase();
  var body = _.pick(req.body, ['key', 'ad','ed', 'deviceid','active','year']);


  Licence.findOneAndUpdate({key}, {$set: body}, {new: true}).then((doc) => {
    if (!doc) {
      return res.status(404).send();
    }

    res.send({doc});
  }).catch((e) => {
    res.status(400).send();
  })
});

// --------------------------------
// user for licence creator
// --------------------------------

app.post('/loginUser', (req, res) => {
  var body = _.pick(req.body, ['username', 'password']);

  User.findByCredentials(body.username, body.password).then((user) => {
    return user.generateAuthToken().then((token) => {
      res.header('x-auth', token).send({token,user});
    });
  }).catch((e) => {
    res.status(400).send();
  });
});

app.post('/logoutUser', authenticate, (req, res) => {
  req.user.removeToken(req.token).then(() => {
    res.status(200).send();
  }, () => {
    res.status(400).send();
  });
});

// app.post('/registerUser', (req, res) => {
//   var body = _.pick(req.body, ['username', 'password']);
//   var user = new User(body);

//   user.save().then(() => {
//     return user.generateAuthToken();
//   }).then((token) => {
//     res.header('x-auth', token).send({token,user});
//   }).catch((e) => {
//     res.status(400).send(e);
//   })
// });


// --------------------------------
// listen
// --------------------------------

app.listen(port, () => {
  console.log(`Started up at port ${port}`);
});

module.exports = {app};
